name: Deploy to GitHub Pages

on:
  # masterブランチへのプッシュ時に自動デプロイ
  push:
    branches:
      - master
  # 手動デプロイも可能（指示があったときだけサイトにアップロード）
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: false

      - name: Get repository name
        id: repo
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          if [ -z "$REPO_NAME" ]; then
            echo "Error: Repository name is empty"
            exit 1
          fi
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "Repository name: $REPO_NAME"
          echo "Full repository: ${{ github.repository }}"

      - name: Build
        env:
          # リポジトリ名を取得してbaseパスを設定
          VITE_BASE_PATH: /${{ steps.repo.outputs.name }}/
        run: |
          echo "Building with base path: $VITE_BASE_PATH"
          # 環境変数が正しく設定されているか確認
          echo "VITE_BASE_PATH=$VITE_BASE_PATH"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          # ビルド実行（環境変数を直接指定）
          VITE_BASE_PATH="$VITE_BASE_PATH" npm run build || {
            echo "❌ Build failed!"
            exit 1
          }
          # ビルド後の確認
          echo "Verifying build output..."
          if [ -f "dist/index.html" ]; then
            echo "✅ dist/index.html exists"
            EXPECTED_BASE="/${{ steps.repo.outputs.name }}/"
            echo "Expected base path: $EXPECTED_BASE"
            echo "Checking index.html for base path..."
            # baseパスが正しく適用されているか確認
            if grep -q "$EXPECTED_BASE" dist/index.html; then
              echo "✅ Base path $EXPECTED_BASE found in index.html"
              echo "Sample lines with base path:"
              grep "$EXPECTED_BASE" dist/index.html | head -n 3
            else
              echo "⚠️  Warning: Base path $EXPECTED_BASE not found in index.html"
              echo "Checking for asset paths in index.html:"
              grep -E "(href|src)=" dist/index.html | head -n 10
              echo ""
              echo "Checking vite.config.ts base setting..."
              echo "First 20 lines of dist/index.html:"
              head -n 20 dist/index.html
            fi
          else
            echo "❌ dist/index.html not found!"
            exit 1
          fi

      - name: Create 404.html for SPA routing
        run: |
          # GitHub PagesでSPAのルーティングを有効にするため、404.htmlを作成
          if [ -f "dist/index.html" ]; then
            BASE_PATH="/${{ steps.repo.outputs.name }}/"
            
            # index.htmlにクエリパラメータ形式のURLを処理するスクリプトを追加
            printf '<script>\n(function() {\n  var l = window.location;\n  var search = l.search;\n  if (search && search.startsWith("?/")) {\n    var path = search.slice(2).replace(/~and~/g, "&");\n    var queryIndex = path.indexOf("&");\n    var basePath = l.pathname.split("/").slice(0, 2).join("/") + "/";\n    var routePath = queryIndex !== -1 ? path.slice(0, queryIndex) : path;\n    var queryParams = queryIndex !== -1 ? path.slice(queryIndex + 1).replace(/~and~/g, "&") : "";\n    var newPath = basePath + routePath;\n    var newQuery = queryParams ? "?" + queryParams : "";\n    window.history.replaceState({}, "", newPath + newQuery + l.hash);\n  }\n})();\n</script>\n' > /tmp/spa-handler.js
            
            # </head>タグの直前にSPAハンドラーを挿入
            sed -i "/<\/head>/r /tmp/spa-handler.js" dist/index.html
            
            # index.htmlをコピーして404.htmlを作成
            cp dist/index.html dist/404.html
            
            # 404.html用のリダイレクトスクリプトを作成（baseパスとクエリパラメータを考慮）
            printf '<script>\n(function() {\n  var basePath = "%s";\n  var l = window.location;\n  var pathname = l.pathname;\n  if (pathname.startsWith(basePath)) {\n    var pathAfterBase = pathname.slice(basePath.length);\n    if (pathAfterBase.startsWith("/")) pathAfterBase = pathAfterBase.slice(1);\n    if (!pathAfterBase) pathAfterBase = "top";\n    var redirectUrl = basePath + "?/" + pathAfterBase.replace(/&/g, "~and~");\n    if (l.search && !l.search.startsWith("?/")) {\n      var searchParams = l.search.slice(1).replace(/&/g, "~and~");\n      if (searchParams) redirectUrl += "&" + searchParams;\n    }\n    if (l.hash) redirectUrl += l.hash;\n    l.replace(redirectUrl);\n  } else if (pathname === basePath.slice(0, -1) || pathname === basePath) {\n    l.replace(basePath + "?/top" + (l.search ? "&" + l.search.slice(1).replace(/&/g, "~and~") : "") + (l.hash || ""));\n  }\n})();\n</script>\n' "$BASE_PATH" > /tmp/redirect.js
            
            # </head>タグの直前にリダイレクトスクリプトを挿入
            sed -i "/<\/head>/r /tmp/redirect.js" dist/404.html
            
            echo "✅ Created dist/404.html and added SPA routing scripts with base path: $BASE_PATH"
          else
            echo "❌ dist/index.html not found, cannot create 404.html"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Verify deployment
        run: |
          echo "=========================================="
          echo "デプロイ検証"
          echo "=========================================="
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          DEPLOY_URL="${{ steps.deployment.outputs.page_url }}"
          if [ -z "$DEPLOY_URL" ]; then
            DEPLOY_URL="https://${{ github.repository_owner }}.github.io/$REPO_NAME/"
          fi
          echo "デプロイURL: $DEPLOY_URL"
          echo ""
          echo "サイトへのアクセスを確認中..."
          HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL" || echo "000")
          if echo "$HTTP_CODE" | grep -qE "200|301|302"; then
            echo "✅ サイトは正常にアクセス可能です (HTTP $HTTP_CODE)"
            echo "デプロイが正常に完了しました"
          else
            echo "⚠️  サイトへのアクセス確認に失敗しました (HTTP $HTTP_CODE)"
            echo "数分待ってから再度確認してください"
            echo "GitHub Pagesの反映には数分かかる場合があります"
            echo ""
            echo "確認URL: $DEPLOY_URL"
          fi
          echo ""
          echo "=========================================="