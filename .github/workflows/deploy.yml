name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get repository name
        id: repo
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          if [ -z "$REPO_NAME" ]; then
            echo "Error: Repository name is empty"
            exit 1
          fi
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "Repository name: $REPO_NAME"
          echo "Full repository: ${{ github.repository }}"

      - name: Build
        env:
          # リポジトリ名を取得してbaseパスを設定
          VITE_BASE_PATH: /${{ steps.repo.outputs.name }}/
        run: |
          echo "Building with base path: $VITE_BASE_PATH"
          # 環境変数が正しく設定されているか確認
          echo "VITE_BASE_PATH=$VITE_BASE_PATH"
          # ビルド実行（環境変数を直接指定）
          VITE_BASE_PATH="$VITE_BASE_PATH" npm run build
          # ビルド後の確認
          echo "Verifying build output..."
          if [ -f "dist/index.html" ]; then
            echo "✅ dist/index.html exists"
            EXPECTED_BASE="/${{ steps.repo.outputs.name }}/"
            echo "Expected base path: $EXPECTED_BASE"
            echo "Checking index.html for base path..."
            # baseパスが正しく適用されているか確認
            if grep -q "$EXPECTED_BASE" dist/index.html; then
              echo "✅ Base path $EXPECTED_BASE found in index.html"
              echo "Sample lines with base path:"
              grep "$EXPECTED_BASE" dist/index.html | head -n 3
            else
              echo "⚠️  Warning: Base path $EXPECTED_BASE not found in index.html"
              echo "Checking for asset paths in index.html:"
              grep -E "(href|src)=" dist/index.html | head -n 10
              echo ""
              echo "Checking vite.config.ts base setting..."
              echo "First 20 lines of dist/index.html:"
              head -n 20 dist/index.html
            fi
          else
            echo "❌ dist/index.html not found!"
            exit 1
          fi

      - name: Create 404.html for SPA routing
        run: |
          # GitHub PagesでSPAのルーティングを有効にするため、404.htmlを作成
          if [ -f "dist/index.html" ]; then
            BASE_PATH="/${{ steps.repo.outputs.name }}/"
            
            # index.htmlにクエリパラメータ形式のURLを処理するスクリプトを追加
            cat > /tmp/spa-handler.js << 'SPAEOF'
<script>
(function() {
  var l = window.location;
  var search = l.search;
  if (search && search.startsWith('?/')) {
    var path = search.slice(2).replace(/~and~/g, '&');
    var queryIndex = path.indexOf('&');
    var basePath = l.pathname.split('/').slice(0, 2).join('/') + '/';
    var newPath = basePath + (queryIndex !== -1 ? path.slice(0, queryIndex) : path);
    var query = queryIndex !== -1 ? '?' + path.slice(queryIndex + 1).replace(/~and~/g, '&') : '';
    window.history.replaceState({}, '', newPath + query + l.hash);
  }
})();
</script>
SPAEOF
            # </head>タグの直前にSPAハンドラーを挿入
            sed -i "/<\/head>/r /tmp/spa-handler.js" dist/index.html
            
            # index.htmlをコピーして404.htmlを作成
            cp dist/index.html dist/404.html
            
            # 404.html用のリダイレクトスクリプトを作成（baseパスを考慮）
            cat > /tmp/redirect.js << EOF
<script>
(function() {
  var basePath = '$BASE_PATH';
  var l = window.location;
  var pathname = l.pathname;
  
  if (pathname.startsWith(basePath)) {
    var pathAfterBase = pathname.slice(basePath.length - 1);
    var redirectUrl = basePath + '?/' + pathAfterBase.replace(/&/g, '~and~');
    if (l.search && !l.search.startsWith('?/')) {
      redirectUrl += '&' + l.search.slice(1).replace(/&/g, '~and~');
    }
    redirectUrl += l.hash;
    l.replace(redirectUrl);
  }
})();
</script>
EOF
            # </head>タグの直前にリダイレクトスクリプトを挿入
            sed -i "/<\/head>/r /tmp/redirect.js" dist/404.html
            
            echo "✅ Created dist/404.html and added SPA routing scripts with base path: $BASE_PATH"
          else
            echo "❌ dist/index.html not found, cannot create 404.html"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
